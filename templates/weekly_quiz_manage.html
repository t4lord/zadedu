{% extends "base.html" %}
{% block title %}Ø£Ø³Ø¦Ù„Ø© Ø£Ø³Ø¨ÙˆØ¹ {{ week.number }} â€” {{ subject.name }}{% endblock %}
{% block extra_css %}
  <style>
    :root{
      --bg:#fff; --ink:#111; --muted:#666; --bd:#e7e7e7;
      --badge:#eef; --badgebd:#dde;
      --label:#f4f8ff; --labelbd:#bcd;
      --chip:#f6f7fb; --chipbd:#dfe6ff;
      --mcq:#7fb0ff; --tf:#2a7d46; --ok:#0a7;
    }
    body{font-family:system-ui,Tahoma; margin:2rem; color:var(--ink); background:var(--bg)}
    .row{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center}
    .split{display:grid; gap:1rem; grid-template-columns:1fr; margin-top:1rem}
    @media(min-width:980px){ .split{grid-template-columns:1.25fr .75fr} }
    .card{border:1px solid var(--bd); border-radius:14px; padding:1rem; background:#fff}
    .badge{display:inline-block; background:var(--badge); border:1px solid var(--badgebd); padding:.25rem .6rem; border-radius:8px; font-size:.9rem; margin-inline-end:.25rem}
    .btn{padding:.45rem .75rem; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:.35rem}
    .btn:hover{background:#f7f7f7}
    .btn--danger{border-color:#f3d0d0}
    .btn--danger:hover{background:#fff6f6}
    .inp{width:100%; padding:.55rem .7rem; border:1px solid #ccc; border-radius:10px}
    h1{margin:.6rem 0 0}
    h2{margin:0 0 .6rem 0; font-size:1.06rem}
    .muted{color:var(--muted)}
    .toolbar{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center}
    .chip{border:1px solid var(--chipbd); background:var(--chip); border-radius:999px; padding:.28rem .7rem; cursor:pointer; font-size:.92rem}
    .chip.active{background:#eaf1ff; border-color:#aac7ff}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
    #qList{display:flex; flex-direction:column; gap:1rem}
    .qcard{
      position:relative;
      border:1px solid var(--bd); border-radius:14px; padding:1rem;
      background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.03);
      border-inline-start:8px solid transparent;
    }
    .qcard--mcq{border-inline-start-color:var(--mcq); background:
      linear-gradient(90deg, rgba(127,176,255,.10) 0%, transparent 38%)}
    .qcard--tf{border-inline-start-color:var(--tf); background:
      linear-gradient(90deg, rgba(42,125,70,.08) 0%, transparent 38%)}

    .qhead{display:flex; justify-content:space-between; align-items:center; gap:.6rem; flex-wrap:wrap}
    .labels{display:flex; gap:.4rem; align-items:center; flex-wrap:wrap}
    .label{display:inline-block; background:var(--label); border:1px solid var(--labelbd); border-radius:999px; padding:.1rem .6rem; font-size:.88rem}
    .qnum{font-weight:700}
    .qtitle{font-weight:700; margin:.4rem 0 .6rem 0; font-size:1.02rem}

    .opts{display:flex; flex-direction:column; gap:.45rem}
    .opt{border:1px dashed #e6e6e6; border-radius:10px; padding:.5rem .6rem}
    .opthdr{display:flex; justify-content:space-between; align-items:center; gap:.6rem; flex-wrap:wrap}
    .optedit{display:none; margin-top:.35rem}
    .optedit .inp{min-width:220px}
    .qedit{display:none; margin-top:.6rem; border-top:1px dashed var(--bd); padding-top:.6rem}

    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµØ­ÙŠØ­ */
    .opt--correct{background:#e9f9ee; border-color:#bfe8c8}

    /* segmented */
    .seg{display:flex; gap:.4rem; align-items:center; flex-wrap:wrap}
    .seg__btn{padding:.45rem .7rem; border-radius:999px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:600}
    .seg__btn.active{background:#e9f2ff; border-color:#7fb0ff}
    .seg__btn.ok.active{background:#e9f9ee; border-color:#2a7d46; color:#2a7d46}

    .weekctrl{display:flex; gap:.4rem; align-items:center}
    .wkbtn{width:36px; height:36px; border-radius:50%; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:700}
    .wknum{min-width:96px; text-align:center; font-weight:700}
    .wkselect{min-width:120px}

    /* Ø£Ø²Ø±Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
    .icon-btn{
      background:transparent;
      border:0;
      padding:.25rem .35rem;
      line-height:1;
      font-size:18px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
    }
    .icon-btn:hover{opacity:.8}
    .icon-btn--danger{color:#b00020}

    /* Saving overlay */
    .saving-overlay{position:fixed; inset:0; background:rgba(255,255,255,.7); display:none; align-items:center; justify-content:center; z-index:9999}
    .saving-overlay--on{display:flex}
    .saving-box{background:#fff; border:1px solid var(--bd); border-radius:12px; padding:1rem 1.2rem; box-shadow:0 6px 24px rgba(0,0,0,.08); font-weight:700}
  </style>
{% endblock %}

{% block content %}
  {% if qform.errors %}
  <div style="border:1px solid #f3d0d0; background:#fff6f6; border-radius:10px; padding:.6rem; margin-bottom:.6rem">
    <strong>ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª:</strong>
    <ul style="margin:.4rem 0 0 1rem">
      {% for field in qform %}{% for err in field.errors %}<li>{{ err }}</li>{% endfor %}{% endfor %}
      {% for err in qform.non_field_errors %}<li>{{ err }}</li>{% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="row" style="justify-content:space-between">
    <div>
      <span class="badge">Ø§Ù„Ø³Ù†Ø©: {{ term.year }}</span>
      <span class="badge">Ø§Ù„ÙØµÙ„: {{ term.get_number_display }}</span>
      <span class="badge">Ø§Ù„Ù…Ø§Ø¯Ø©: {{ subject.name }}</span>
      <span class="badge">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: {{ week.number }}</span>
    </div>
    <div class="row">
      <a class="btn" href="{% url 'subjects_grid' term.id %}">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙˆØ§Ø¯</a>
    </div>
  </div>

  <h1>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© â€” {{ subject.name }}</h1>

  <div class="card">
    <div class="toolbar" style="width:100%">
      <div class="weekctrl" data-weeks="{{ WEEKS_PER_TERM }}">
        <button class="wkbtn" id="weekPrev" type="button" aria-label="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚">â—€</button>
        <div class="wknum">Ø£Ø³Ø¨ÙˆØ¹ <span id="weekNum">{{ week.number }}</span></div>
        <button class="wkbtn" id="weekNext" type="button" aria-label="Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ">â–¶</button>
      </div>

      <div class="row" style="margin-inline-start:.6rem">
        <label for="weekSelect" class="muted">Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ø±ÙŠØ¹:</label>
        <select id="weekSelect" class="inp wkselect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¨ÙˆØ¹">
          {% for w in weeks %}
            <option value="{{ w.number }}" {% if w.number == week.number %}selected{% endif %}>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ {{ w.number }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="row" id="typeFilters" aria-label="ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ÙˆØ¹" style="margin-inline-start:auto">
        <button class="chip active" data-type="ALL">Ø§Ù„ÙƒÙ„</button>
        <button class="chip" data-type="MCQ">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
        <button class="chip" data-type="TF">ØµØ­/Ø®Ø·Ø£</button>
      </div>

      <input id="qSearch" class="inp" style="min-width:240px" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„â€¦">
    </div>
  </div>

  <div class="split">
    <!-- ÙŠØ³Ø§Ø±: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <section class="card">
      <h2>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ({{ questions|length }})</h2>
      {% if questions %}
        <div id="qList">
          {% for q in questions %}
            <article class="qcard qcard--{{ q.qtype|lower }}" data-type="{{ q.qtype }}" data-qid="{{ q.id }}" data-text="{{ q.text|lower }}">
              <div class="qhead">
                <div class="labels">
                  <span class="label qnum">Ø³Ø¤Ø§Ù„ #{{ forloop.counter }}</span>
                  <span class="label">{% if q.qtype == QuestionType.MCQ %}Ø§Ø®ØªÙŠØ§Ø±Ø§Øª{% else %}ØµØ­/Ø®Ø·Ø£{% endif %}</span>
                </div>
                <div class="row">
                  <!-- ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ -->
                  <button class="icon-btn toggle-edit" type="button" data-qid="{{ q.id }}" title="ØªØ¹Ø¯ÙŠÙ„" aria-label="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                  <form method="post" onsubmit="return confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ');">
                    {% csrf_token %}
                    <input type="hidden" name="form_name" value="delete_question">
                    <input type="hidden" name="question_id" value="{{ q.id }}">
                    <button class="icon-btn icon-btn--danger" type="submit" title="Ø­Ø°Ù" aria-label="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                  </form>
                </div>
              </div>

              <div class="qtitle">{{ q.text }}</div>

              {% if q.qtype == QuestionType.MCQ %}
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø±Ø£Ø³ ÙƒÙ„ Ø®ÙŠØ§Ø±ØŒ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø®Ù„ÙÙŠØ© -->
                <div class="opts">
                  {% for opt in q.choices.all %}
                    <div class="opt {% if opt.is_correct %}opt--correct{% endif %}" id="opt-{{ opt.id }}">
                      <div class="opthdr">
                        <div><strong>{{ opt.text }}</strong></div>
                      </div>
                      <!-- Ù…ÙØ­Ø±Ù‘ÙØ± Ø§Ù„Ø®ÙŠØ§Ø± (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„) -->
                      <div class="optedit" id="optedit-{{ opt.id }}">
                        <form method="post" class="row" style="margin-top:.35rem">
                          {% csrf_token %}
                          <input type="hidden" name="form_name" value="edit_option">
                          <input type="hidden" name="option_id" value="{{ opt.id }}">
                          <input type="hidden" name="order" value="{{ opt.order|default:0 }}">
                          <input class="inp" name="text" value="{{ opt.text }}" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø±" style="flex:1">
                          <label class="row" style="align-items:center">
                            <span class="muted" style="margin-inline-end:.35rem">ØµØ­ÙŠØ­ØŸ</span>
                            <input type="checkbox" name="is_correct" {% if opt.is_correct %}checked{% endif %}>
                          </label>
                          <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸</button>
                        </form>
                        <small class="muted">Ø¹Ù†Ø¯ ØªØ¹ÙŠÙŠÙ† Ø®ÙŠØ§Ø± ÙƒØµØ­ÙŠØ­ØŒ Ø³ÙŠÙÙ„ØºÙ‰ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¹Ù† ØºÙŠØ±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>
                      </div>
                    </div>
                  {% empty %}
                    <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯.</div>
                  {% endfor %}
                </div>

                <!-- ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙ‚Ø· -->
                <div class="qedit" id="qedit-{{ q.id }}">
                  <form method="post" class="row">
                    {% csrf_token %}
                    <input type="hidden" name="form_name" value="edit_question_{{ q.id }}">
                    <input type="hidden" name="question_id" value="{{ q.id }}">
                    <input type="hidden" name="qtype" value="MCQ">
                    <input type="hidden" name="order" value="{{ q.order|default:0 }}"/>
                    <textarea name="text" class="inp" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" style="flex:1">{{ q.text }}</textarea>
                    <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                  </form>
                </div>

              {% else %} {# TF #}

                {# Ø¹Ø±Ø¶ (Ù‚Ø±Ø§Ø¡Ø©) â€” Ù„Ø§ Ø­ÙØ¸ Ù‡Ù†Ø§ØŒ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù„ÙˆÙ‘Ù† Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² #}
                <div class="qview" id="qview-{{ q.id }}">
                  <div class="seg" aria-label="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©" style="margin-bottom:.5rem">
                    <button type="button" class="seg__btn ok {% if q.correct_bool is True %}active{% endif %}" disabled>ØµØ­</button>
                    <button type="button" class="seg__btn {% if q.correct_bool is False %}active{% endif %}" disabled>Ø®Ø·Ø£</button>
                  </div>
                  <div class="qtitle" style="margin-top:.4rem">{{ q.text }}</div>
                </div>

                {# ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) â€” ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ âœï¸ Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© #}
                <div class="qedit" id="qedit-{{ q.id }}">
                  <form method="post" class="row" data-tf="{{ q.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="form_name" value="edit_question_{{ q.id }}">
                    <input type="hidden" name="question_id" value="{{ q.id }}">
                    <input type="hidden" name="qtype" value="TF">
                    <input type="hidden" name="order" value="{{ q.order|default:0 }}">
                    <input type="hidden" name="correct_bool" id="cb-{{ q.id }}" value="{% if q.correct_bool is True %}2{% elif q.correct_bool is False %}3{% else %}{% endif %}">

                    <div class="seg" aria-label="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©">
                      <button type="button" class="seg__btn ok {% if q.correct_bool is True %}active{% endif %}" data-target="#cb-{{ q.id }}" data-val="2">ØµØ­</button>
                      <button type="button" class="seg__btn {% if q.correct_bool is False %}active{% endif %}" data-target="#cb-{{ q.id }}" data-val="3">Ø®Ø·Ø£</button>
                    </div>

                    <textarea name="text" class="inp" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" style="flex:1">{{ q.text }}</textarea>

                    <!-- Ø­ÙØ¸ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                    <button class="btn" type="submit" title="Ø­ÙØ¸">ğŸ’¾ Ø­ÙØ¸</button>
                  </form>
                </div>

              {% endif %}
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¹Ø¯.</div>
      {% endif %}
    </section>

    <!-- ÙŠÙ…ÙŠÙ†: Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ -->
    <aside class="card">
      <h2>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>
      <form method="post" id="addForm">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="add_question">

        {{ qform.text }}

        <!-- Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
        <input type="hidden" name="qtype" id="qtypeHidden" value="MCQ">
        <div class="row" style="margin-top:.5rem; align-items:flex-end">
          <div style="flex:1">
            <div class="seg" id="qtypeSeg">
              <button type="button" class="seg__btn active" data-val="MCQ">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
              <button type="button" class="seg__btn" data-val="TF">ØµØ­/Ø®Ø·Ø£</button>
            </div>
          </div>

          <!-- Ø¥Ø¬Ø§Ø¨Ø© TF -->
          <div id="tfWrap" style="flex:1; display:none">
            <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
            <input type="hidden" name="correct_bool" id="addCorrectBool" value="">
            <div class="seg">
              <button type="button" class="seg__btn ok" data-target="#addCorrectBool" data-val="2">ØµØ­</button>
              <button type="button" class="seg__btn" data-target="#addCorrectBool" data-val="3">Ø®Ø·Ø£</button>
            </div>
          </div>
        </div>

        <!-- 3 Ø®Ø§Ù†Ø§Øª Ù„Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ -->
        <div id="mcqWrap" style="display:block; margin-top:.6rem">
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label>Ø§Ù„Ø®ÙŠØ§Ø± 1</label>
              <input class="inp" name="mcq_choice1" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 1">
            </div>
            <div class="seg">
              <button type="button" class="seg__btn" data-mcq-radio="1" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø± 1 ÙƒØ¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©">1</button>
            </div>
          </div>

          <div class="row" style="align-items:flex-end; margin-top:.35rem">
            <div style="flex:1">
              <label>Ø§Ù„Ø®ÙŠØ§Ø± 2</label>
              <input class="inp" name="mcq_choice2" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 2">
            </div>
            <div class="seg">
              <button type="button" class="seg__btn" data-mcq-radio="2" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø± 2 ÙƒØ¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©">2</button>
            </div>
          </div>

          <div class="row" style="align-items:flex-end; margin-top:.35rem">
            <div style="flex:1">
              <label>Ø§Ù„Ø®ÙŠØ§Ø± 3</label>
              <input class="inp" name="mcq_choice3" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 3 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>
            <div class="seg">
              <button type="button" class="seg__btn" data-mcq-radio="3" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø± 3 ÙƒØ¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©">3</button>
            </div>
          </div>

          <input type="hidden" name="mcq_correct" id="mcqCorrect" value="">
          <small class="muted" style="display:block; margin-top:.35rem">
            ØªÙÙ†Ø´Ø£ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„. Ø§Ù„ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.
          </small>
        </div>

        <input type="hidden" name="order" value="0">

        <div class="row" style="margin-top:.7rem">
          <button class="btn" type="submit">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„</button>
        </div>
      </form>
    </aside>
  </div>

  <!-- Overlay: saving options via fetch -->
  <div id="savingOverlay" class="saving-overlay" aria-live="polite" aria-busy="true">
    <div class="saving-box">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦ <span id="savingProgress"></span></div>
  </div>

{% endblock %}

{% block extra_js %}
  <script>
    // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø¨ÙˆØ§Ø³Ø·Ø© data-toggle (Ù„Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
    document.querySelectorAll('[data-toggle]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const el = document.querySelector(btn.getAttribute('data-toggle'));
        if(!el) return; el.style.display = (el.style.display === 'block') ? 'none' : 'block';
      });
    });

    // Ø²Ø± âœï¸ ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ø³Ø¤Ø§Ù„: ÙŠÙØªØ­ qedit ÙˆÙŠÙØ¸Ù‡Ø± Ù…Ø­Ø±Ø±Ø§Øª Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡
    document.querySelectorAll('.toggle-edit').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const card = btn.closest('.qcard');
        if (!card) return;
        const qedit = card.querySelector('.qedit');
        if (qedit) qedit.style.display = (qedit.style.display==='block') ? 'none' : 'block';
        // Ø£Ø¸Ù‡Ø±/Ø£Ø®ÙÙ ÙƒÙ„ Ù…Ø­Ø±Ø±Ø§Øª Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
        card.querySelectorAll('.optedit').forEach(el=>{
          el.style.display = qedit && qedit.style.display==='block' ? 'block' : 'none';
        });
      });
    });

    // ÙÙ„ØªØ±Ø© + Ø¨Ø­Ø«
    const chips = document.querySelectorAll('#typeFilters .chip');
    const list  = document.getElementById('qList');
    const search= document.getElementById('qSearch');
    let activeType = 'ALL';
    function applyFilter(){
      const q = (search?.value || '').toLowerCase().trim();
      if(!list) return;
      [...list.children].forEach(card=>{
        const t = card.getAttribute('data-type');
        const text = (card.getAttribute('data-text')||'');
        const okType = (activeType==='ALL' || t===activeType);
        const okText = (!q || text.includes(q));
        card.style.display = (okType && okText) ? '' : 'none';
      });
    }
    chips.forEach(c=>c.addEventListener('click', ()=>{
      chips.forEach(x=>x.classList.remove('active'));
      c.classList.add('active'); activeType=c.dataset.type; applyFilter();
    }));
    search?.addEventListener('input', applyFilter);

    // ØªÙ†Ù‚Ù‘Ù„ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
    const wkPrev = document.getElementById('weekPrev'),
          wkNext = document.getElementById('weekNext'),
          wkNum  = document.getElementById('weekNum');
    const maxW   = parseInt(document.querySelector('.weekctrl')?.dataset.weeks || '16', 10);
    const weekSelect = document.getElementById('weekSelect');
    const scrollKey = `wq_scroll_{{ term.id }}_{{ subject.id }}`;
    const restoreKey = `wq_restore_{{ term.id }}_{{ subject.id }}`;
    function gotoWeek(n){
      n=Math.max(1,Math.min(maxW,n));
      // Ø§Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø«Ù… Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹
      try { sessionStorage.setItem(scrollKey, String(window.scrollY || window.pageYOffset || 0)); sessionStorage.setItem(restoreKey, '1'); } catch {}
      const url=new URL(window.location.href);
      url.searchParams.set('week', String(n));
      window.location.href=url.toString();
    }
    wkPrev?.addEventListener('click', ()=> gotoWeek(parseInt(wkNum.textContent,10)-1));
    wkNext?.addEventListener('click', ()=> gotoWeek(parseInt(wkNum.textContent,10)+1));
    weekSelect?.addEventListener('change', ()=> gotoWeek(parseInt(weekSelect.value, 10)));

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
    (function restoreScroll(){
      try {
        const should = sessionStorage.getItem(restoreKey) === '1';
        const v = parseInt(sessionStorage.getItem(scrollKey) || '0', 10);
        if (should && !isNaN(v)) {
          window.scrollTo({ top: v, behavior: 'instant' });
        }
        sessionStorage.removeItem(restoreKey);
      } catch {}
    })();

    // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø°Ø§Øª data-target (TF ÙÙ‚Ø·)
    function bindSegToHidden(root) {
      root.querySelectorAll('.seg__btn[data-val][data-target]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const targetSel = btn.getAttribute('data-target');
          const hidden = document.querySelector(targetSel);
          if (!hidden) return;
          btn.parentElement.querySelectorAll('.seg__btn[data-target]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          hidden.value = btn.getAttribute('data-val'); // 2/3
        });
      });
    }
    document.querySelectorAll('form[data-tf]').forEach(f=>bindSegToHidden(f));
    const tfWrap = document.getElementById('tfWrap'); if (tfWrap) bindSegToHidden(tfWrap);

    // Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ + Ù…ØªØ·Ù„Ø¨Ø§Øª MCQ
    const addForm        = document.getElementById('addForm');
    const qtypeSeg       = document.getElementById('qtypeSeg');
    const qtypeHidden    = document.getElementById('qtypeHidden');
    const mcqWrap        = document.getElementById('mcqWrap');
    const addCorrectBool = document.getElementById('addCorrectBool');
    const mcqInputs = ['mcq_choice1','mcq_choice2','mcq_choice3'].map(n => addForm?.querySelector(`[name="${n}"]`));

    function setMCQRequirements(enable){
      mcqInputs.forEach((inp, idx)=>{
        if(!inp) return;
        if(enable){
          inp.removeAttribute('disabled');
          if(idx<2) inp.setAttribute('required','required'); else inp.removeAttribute('required');
        }else{
          inp.setAttribute('disabled','disabled'); inp.removeAttribute('required');
        }
      });
    }
    qtypeSeg?.querySelectorAll('.seg__btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qtypeSeg.querySelectorAll('.seg__btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const v = btn.dataset.val;
        qtypeHidden.value = v;
        if (v === 'TF'){
          tfWrap.style.display=''; mcqWrap.style.display='none'; setMCQRequirements(false);
        } else {
          tfWrap.style.display='none'; mcqWrap.style.display=''; setMCQRequirements(true);
          if(addCorrectBool) addCorrectBool.value='';
        }
      });
    });

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ MCQ
    const mcqCorrect = document.getElementById('mcqCorrect');
    document.querySelectorAll('[data-mcq-radio]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('[data-mcq-radio]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        mcqCorrect.value = btn.getAttribute('data-mcq-radio');
      });
    });

    // Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ©
    (function ini(){
      if (qtypeHidden?.value === 'TF'){
        tfWrap.style.display=''; mcqWrap.style.display='none'; setMCQRequirements(false);
      } else {
        tfWrap.style.display='none'; mcqWrap.style.display=''; setMCQRequirements(true);
      }
    })();

    // ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ + ØªØ®Ø²ÙŠÙ† Ø®ÙŠØ§Ø±Ø§Øª MCQ Ù…Ø¤Ù‚ØªÙ‹Ø§
    const weekNum = "{{ week.number }}";
    function norm(s){ return (s||'').toString().trim(); }
    function normKey(s){ return norm(s).toLowerCase().replace(/\s+/g,' '); }

    // ØªØ­ÙˆÙŠÙ„ 2/3 â†’ True/False ÙÙŠ Ø¥Ø¶Ø§ÙØ© TF
    addForm?.addEventListener('submit', (e)=>{
      if (qtypeHidden.value === 'TF') {
        setMCQRequirements(false);
        const vRaw = addCorrectBool?.value;
        if (vRaw !== '2' && vRaw !== '3') { e.preventDefault(); alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Â«ØµØ­Â» Ø£Ùˆ Â«Ø®Ø·Ø£Â».'); return; }
        addCorrectBool.value = (vRaw === '2') ? 'True' : 'False';
        localStorage.removeItem('pending_mcq_options');
      } else {
        setMCQRequirements(true);
        const t  = addForm.querySelector('[name="text"]');
        const c1 = addForm.querySelector('[name="mcq_choice1"]')?.value || '';
        const c2 = addForm.querySelector('[name="mcq_choice2"]')?.value || '';
        const c3 = addForm.querySelector('[name="mcq_choice3"]')?.value || '';
        const sel= mcqCorrect?.value || '';
        const nonEmpty = [c1,c2,c3].map(norm).filter(Boolean);
        if (!norm(t?.value) || nonEmpty.length < 2 || !['1','2','3'].includes(sel)) {
          e.preventDefault(); alert('Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª: Ø£Ø¯Ø®Ù„ Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ­Ø¯Ù‘Ø¯ Ø§Ù„ØµØ­ÙŠØ­.'); return;
        }
        const payload = { t: normKey(t.value), week: weekNum, options: [
          {t:norm(c1), ok:(sel==='1')},
          {t:norm(c2), ok:(sel==='2')},
          {t:norm(c3), ok:(sel==='3')}
        ]};
        localStorage.setItem('pending_mcq_options', JSON.stringify(payload));
      }
    }, true);

    // ØªØ­ÙˆÙŠÙ„ 2/3 â†’ True/False ÙÙŠ ØªØ­Ø±ÙŠØ± TF
    document.querySelectorAll('form[data-tf]').forEach(f=>{
      f.addEventListener('submit', ()=>{
        const hid = f.querySelector('input[name="correct_bool"]');
        if (!hid) return;
        const vRaw = hid.value;
        if (vRaw === '2') hid.value = 'True';
        else if (vRaw === '3') hid.value = 'False';
      }, true);
    });

    // Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹: Ø£Ø¶Ù Ø®ÙŠØ§Ø±Ø§Øª MCQ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø¨Ø¯ÙˆÙ† Ù†Ù…ÙˆØ°Ø¬ "Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±")
    window.addEventListener('DOMContentLoaded', async ()=>{
      const raw = localStorage.getItem('pending_mcq_options');
      if (!raw) return;
      let data; try { data = JSON.parse(raw); } catch { localStorage.removeItem('pending_mcq_options'); return; }
      if (!data || data.week != weekNum) { localStorage.removeItem('pending_mcq_options'); return; }

      const cards  = [...document.querySelectorAll('.qcard[data-type="MCQ"]')];
      const target = cards.find(card => (card.getAttribute('data-text')||'') === data.t);
      const qid    = target?.getAttribute('data-qid');
      if (!qid) { localStorage.removeItem('pending_mcq_options'); return; }

      function getCookie(name){ const m=document.cookie.match(new RegExp('(^|; )'+name+'=([^;]+)')); return m?decodeURIComponent(m[2]):null; }
      const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      const csrf = csrfInput?.value || getCookie('csrftoken');

      const url = window.location.href;
      const opts=(data.options||[]).map(o=>({text:o.t, ok:!!o.ok, order:9999})).filter(o=>o.text);
      // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸" ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      const overlay = document.getElementById('savingOverlay');
      const prog = document.getElementById('savingProgress');
      function setDisabledUI(dis){
        document.querySelectorAll('button, input, select, textarea').forEach(el=>{ try{ el.disabled = !!dis; }catch{} });
        document.querySelectorAll('a.btn').forEach(a=>{ if(dis){ a.classList.add('disabled'); a.style.pointerEvents='none'; a.setAttribute('aria-disabled','true'); } else { a.classList.remove('disabled'); a.style.pointerEvents=''; a.removeAttribute('aria-disabled'); } });
      }
      if (overlay) overlay.classList.add('saving-overlay--on');
      setDisabledUI(true);
      let i = 0; const total = opts.length; if (prog) prog.textContent = `(0/${total})`;
      for (const o of opts) {
        const p = new URLSearchParams();
        p.append('form_name','add_option'); p.append('question_id', qid);
        p.append('text', o.text); if (o.ok) p.append('is_correct','on');
        p.append('order','9999'); if (csrf) p.append('csrfmiddlewaretoken', csrf);
        await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString(), credentials:'same-origin' });
        i++; if (prog) prog.textContent = `(${i}/${total})`;
      }
      localStorage.removeItem('pending_mcq_options');
      window.location.reload();
    });
  </script>
{% endblock %}
