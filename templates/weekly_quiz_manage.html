{% extends "base.html" %}
{% block title %}Ø£Ø³Ø¦Ù„Ø© Ø£Ø³Ø¨ÙˆØ¹ {{ week.number }} â€” {{ subject.name }}{% endblock %}
{% block extra_css %}
  <style>
    :root{
      --bg:#f9f6f2; /* Ø¨ÙŠØ¬ ÙØ§ØªØ­ Ø¬Ø¯Ù‹Ø§ */
      --ink:#111; --muted:#666; --bd:#e7e7e7;
      --card-bg:#fff; /* Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ØµØ§ÙÙŠØ© */
      --badge:#eef; --badgebd:#dde;
      --label:#f4f8ff; --labelbd:#bcd;
      --chip:#f6f7fb; --chipbd:#dfe6ff;
      --mcq:#7fb0ff; --tf:#2a7d46; --ok:#0a7;
    }
    body{font-family:system-ui,Tahoma; margin:2rem; color:var(--ink); background:var(--bg)}
    .row{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center}
    .split{display:grid; gap:1rem; grid-template-columns:1fr; margin-top:1rem}
    @media(min-width:980px){ .split{grid-template-columns:1.25fr .75fr} }
    .card{border:1px solid var(--bd); border-radius:14px; padding:1rem; background:var(--card-bg)}
    .badge{display:inline-block; background:var(--badge); border:1px solid var(--badgebd); padding:.25rem .6rem; border-radius:8px; font-size:.9rem; margin-inline-end:.25rem}
    .btn{padding:.45rem .75rem; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:.35rem}
    .btn:hover{background:#f7f7f7}
    .btn--danger{border-color:#f3d0d0}
    .btn--danger:hover{background:#fff6f6}
    .inp{width:100%; padding:.55rem .7rem; border:1px solid #ccc; border-radius:10px}
    h1{margin:.6rem 0 0}
    h2{margin:0 0 .6rem 0; font-size:1.06rem}
    .muted{color:var(--muted)}
    .toolbar{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center}
    /* Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯: Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‡Ù†Ø§ */
      .toolbar{display:flex; gap:.5rem; flex-wrap:nowrap; align-items:center; overflow:hidden}
      /* Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ø³Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ… */
      .wkbtn, .wknum { display: inline-flex; }
      /* Ø­Ø§ÙˆÙŠØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø±ÙŠØ·: Ø£Ø¬Ø²Ø§Ø¡ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ…Ø¯Ø¯/Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
      .toolbar > .row, .toolbar > input, .toolbar > .weekctrl, .toolbar > .row#typeFilters, .toolbar > .week-select{ flex: 0 0 auto; display:flex; align-items:center; gap:.45rem }
      /* Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙŠØªÙˆØ³Ø¹ ÙˆÙ„ÙƒÙ†Ù‡ ÙŠØ¸Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø± */
      #qSearch{ flex: 1 1 240px; min-width:140px; max-width:640px; margin-left:0 }
      /* Ø§Ø¬Ø¹Ù„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ø§ ØªÙ„ØªÙ‡Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© */
      #typeFilters{ flex: 0 0 auto; }
      #typeFilters .chip{ white-space:nowrap }
      /* Ø§Ø¬Ø¹Ù„ ØªØ³Ù…ÙŠØ© + Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¯Ø§Ø¦Ù…Ù‹Ø§ */
      .week-select{ display:flex; align-items:center; gap:.4rem; white-space:nowrap }
      #weekSelect{ flex:0 0 auto; min-width:120px; max-width:160px }
      /* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ØµØºÙŠØ± ÙˆÙŠØ¬Ù„Ø³ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· */
      .back-btn{ padding:.35rem .6rem; border-radius:10px; font-size:.95rem; border:1px solid #ddd; background:#fff }
      .toolbar .back-btn{ flex:0 0 auto }
      /* Ù‚Ù„Ù„ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ø¹Ù†Ø§ØµØ± */
      .toolbar .row{ margin:0; }
    .chip{border:1px solid var(--chipbd); background:var(--chip); border-radius:999px; padding:.28rem .7rem; cursor:pointer; font-size:.92rem}
    .chip.active{background:#eaf1ff; border-color:#aac7ff}

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
    #qList{display:flex; flex-direction:column; gap:1rem}
    .qcard{
      position:relative;
      border:1px solid var(--bd); border-radius:14px; padding:1rem;
      background:var(--card-bg); box-shadow:0 1px 0 rgba(0,0,0,.03);
      border-inline-start:8px solid transparent;
    }

    /* Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ù…Ø·ÙˆÙŠØ© */
    .qcard:not(.expanded){ cursor: pointer; }
    .qcard--mcq{border-inline-start-color:var(--mcq); background:
      linear-gradient(90deg, rgba(127,176,255,.10) 0%, transparent 38%)}
    .qcard--tf{border-inline-start-color:var(--tf); background:
      linear-gradient(90deg, rgba(42,125,70,.08) 0%, transparent 38%)}

    .qhead{display:flex; justify-content:space-between; align-items:center; gap:.6rem; flex-wrap:wrap}
    .labels{display:flex; gap:.4rem; align-items:center; flex-wrap:wrap}
    .label{display:inline-block; background:var(--label); border:1px solid var(--labelbd); border-radius:999px; padding:.1rem .6rem; font-size:.88rem}
    .qnum{font-weight:700}
    .qtitle{font-weight:700; margin:.4rem 0 .6rem 0; font-size:1.02rem}

    .opts{display:flex; flex-direction:column; gap:.45rem}
    .opt{border:1px dashed #e6e6e6; border-radius:10px; padding:.5rem .6rem}
    .opthdr{display:flex; justify-content:space-between; align-items:center; gap:.6rem; flex-wrap:wrap}
    .optedit{display:none; margin-top:.35rem}
    .optedit .inp{min-width:220px}
    .qedit{display:none; margin-top:.6rem; border-top:1px dashed var(--bd); padding-top:.6rem}

    /* Collapse behavior: show only summary by default */
    .qcard .qtitle, .qcard .opts, .qcard .qview, .qcard .qedit { display: none; }
    /* Ø£Ø®ÙÙ Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­Ø°ÙØŒ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ØŒ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„) ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙŠ */
    .qcard .qhead { display: none; }
    .qcard.expanded .qtitle, .qcard.expanded .opts, .qcard.expanded .qview { display: block; }
    .qcard.expanded .qhead { display: flex; }
    /* Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ³ÙŠØ¹ Ù†Ø®ÙÙ Ù…ÙÙ„Ø®Ù‘Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ø¦Ù„Ø§ ÙŠØªÙƒØ±Ø± Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
    .qcard.expanded .qsummary { display: none; }
    .qsummary{cursor:pointer; padding:.45rem 0; font-weight:700; color:var(--ink);}
    .qsummary small{color:var(--muted); margin-left:.5rem; font-weight:600}
    .qsummary .qicon{display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:6px; background:#f3f7ff; border:1px solid #e0e8ff; margin-inline-end:.6rem; font-size:14px}
    .qsummary .qsummary-text{vertical-align:middle}
    .tf-correct-text{margin-inline-start:.5rem; color:var(--muted); font-style:italic}

    /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµØ­ÙŠØ­ */
    .opt--correct{background:#e9f9ee; border-color:#bfe8c8}

    /* segmented */
    .seg{display:flex; gap:.4rem; align-items:center; flex-wrap:wrap}
    .seg__btn{padding:.45rem .7rem; border-radius:999px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:600}
    .seg__btn.active{background:#e9f2ff; border-color:#7fb0ff}
    .seg__btn.ok.active{background:#e9f9ee; border-color:#2a7d46; color:#2a7d46}

    .weekctrl{display:flex; gap:.4rem; align-items:center}
    .wkbtn{width:36px; height:36px; border-radius:50%; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:700}
    .wknum{min-width:96px; text-align:center; font-weight:700}
    .wkselect{min-width:120px}

    /* Ø£Ø²Ø±Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
    .icon-btn{
      background:transparent;
      border:0;
      padding:.25rem .35rem;
      line-height:1;
      font-size:18px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
    }
    .icon-btn:hover{opacity:.8}
    .icon-btn--danger{color:#b00020}

    /* Saving overlay */
    .saving-overlay{position:fixed; inset:0; background:rgba(255,255,255,.7); display:none; align-items:center; justify-content:center; z-index:9999}
    .saving-overlay--on{display:flex}
    .saving-box{background:#fff; border:1px solid var(--bd); border-radius:12px; padding:1rem 1.2rem; box-shadow:0 6px 24px rgba(0,0,0,.08); font-weight:700}
  </style>
{% endblock %}

{% block content %}
  {% if qform.errors %}
  <div style="border:1px solid #f3d0d0; background:#fff6f6; border-radius:10px; padding:.6rem; margin-bottom:.6rem">
    <strong>ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª:</strong>
    <ul style="margin:.4rem 0 0 1rem">
      {% for field in qform %}{% for err in field.errors %}<li>{{ err }}</li>{% endfor %}{% endfor %}
      {% for err in qform.non_field_errors %}<li>{{ err }}</li>{% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="row" style="justify-content:space-between">
    <div>
      <span class="badge">Ø§Ù„Ø³Ù†Ø©: {{ term.year }}</span>
      <span class="badge">Ø§Ù„ÙØµÙ„: {{ term.get_number_display }}</span>
      <span class="badge">Ø§Ù„Ù…Ø§Ø¯Ø©: {{ subject.name }}</span>
      <span class="badge">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: {{ week.number }}</span>
    </div>
  </div>

  <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø£ÙØ²ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø·Ù„Ø¨: Ø¹Ø±Ø¶ Ù…ÙØ¯Ù…Ø¬ Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙÙ‚Ø· -->

  <div class="card">
    <div class="toolbar" style="width:100%">
      <a class="btn back-btn" href="{% url 'subjects_grid' term.id %}">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙˆØ§Ø¯</a>
      <!-- week navigation removed: using dropdown only -->

      <select id="weekSelect" class="inp wkselect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¨ÙˆØ¹">
        <optgroup label="Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ø±ÙŠØ¹:">
          {% for w in weeks %}
            <option value="{{ w.number }}" {% if w.number == week.number %}selected{% endif %}>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ {{ w.number }}</option>
          {% endfor %}
        </optgroup>
      </select>

      <div class="row" id="typeFilters" aria-label="ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ÙˆØ¹" style="margin-inline-start:8px">
        <button class="chip active" data-type="ALL">Ø§Ù„ÙƒÙ„</button>
        <button class="chip" data-type="MCQ">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
        <button class="chip" data-type="TF">ØµØ­/Ø®Ø·Ø£</button>
      </div>

      <input id="qSearch" class="inp" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„â€¦">
    </div>
  </div>

  <div class="split">
    <!-- ÙŠØ³Ø§Ø±: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <section class="card">
      <h2>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ({{ questions|length }})</h2>
      {% if questions %}
        <div id="qList">
          {% for q in questions %}
            <article class="qcard qcard--{{ q.qtype|lower }}" data-type="{{ q.qtype }}" data-qid="{{ q.id }}" data-text="{{ q.text|lower }}">
              <div class="qhead">
                <div class="labels">
                  <span class="label qnum">Ø³Ø¤Ø§Ù„ #{{ forloop.counter }}</span>
                  <span class="label">{% if q.qtype == QuestionType.MCQ %}Ø§Ø®ØªÙŠØ§Ø±Ø§Øª{% else %}ØµØ­/Ø®Ø·Ø£{% endif %}</span>
                </div>
                <div class="row">
                  <!-- ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„ -->
                  <button class="icon-btn toggle-edit" type="button" data-qid="{{ q.id }}" title="ØªØ¹Ø¯ÙŠÙ„" aria-label="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                  <form method="post" onsubmit="return confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ');">
                    {% csrf_token %}
                    <input type="hidden" name="form_name" value="delete_question">
                    <input type="hidden" name="question_id" value="{{ q.id }}">
                    <button class="icon-btn icon-btn--danger" type="submit" title="Ø­Ø°Ù" aria-label="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                  </form>
                </div>
              </div>

              <div class="qsummary" role="button" tabindex="0" aria-expanded="false">
                <span class="qicon" aria-hidden="true">
                  {% if q.qtype == QuestionType.MCQ %}ğŸ”˜{% elif q.qtype == QuestionType.TF %}âœ”âœ–{% else %}âœï¸{% endif %}
                </span>
                <span class="qsummary-text">{{ q.text|striptags|truncatechars:120 }}</span>
              </div>

              {% if q.qtype == QuestionType.MCQ %}
                <div class="qtitle">#{{ q.id }} â€” {{ q.text|safe }}</div>
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø±Ø£Ø³ ÙƒÙ„ Ø®ÙŠØ§Ø±ØŒ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø®Ù„ÙÙŠØ© -->
                <div class="opts">
                  {% for opt in q.choices_list %}
                    <div class="opt {% if opt.is_correct %}opt--correct{% endif %}" id="opt-{{ opt.id }}">
                      <div class="opthdr">
                        <div><strong>{{ opt.text }}</strong></div>
                      </div>
                      <!-- Ù…ÙØ­Ø±Ù‘ÙØ± Ø§Ù„Ø®ÙŠØ§Ø± (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„) -->
                      <div class="optedit" id="optedit-{{ opt.id }}">
                        <form method="post" class="row" style="margin-top:.35rem">
                          {% csrf_token %}
                          <input type="hidden" name="form_name" value="edit_option">
                          <input type="hidden" name="option_id" value="{{ opt.id }}">
                          <input type="hidden" name="order" value="{{ opt.order|default:0 }}">
                          <input class="inp" name="text" value="{{ opt.text }}" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø±" style="flex:1">
                          <label class="row" style="align-items:center">
                            <span class="muted" style="margin-inline-end:.35rem">ØµØ­ÙŠØ­ØŸ</span>
                            <input type="checkbox" name="is_correct" {% if opt.is_correct %}checked{% endif %}>
                          </label>
                          <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸</button>
                          <button type="button" class="btn cancel-edit" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„">âœ– Ø¥Ù„ØºØ§Ø¡</button>
                        </form>
                        <small class="muted">Ø¹Ù†Ø¯ ØªØ¹ÙŠÙŠÙ† Ø®ÙŠØ§Ø± ÙƒØµØ­ÙŠØ­ØŒ Ø³ÙŠÙÙ„ØºÙ‰ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¹Ù† ØºÙŠØ±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>
                      </div>
                    </div>
                  {% empty %}
                    <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯.</div>
                  {% endfor %}
                </div>

                <!-- ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙ‚Ø· -->
                <div class="qedit" id="qedit-{{ q.id }}">
                  <form method="post" class="row">
                    {% csrf_token %}
                    <input type="hidden" name="form_name" value="edit_question_{{ q.id }}">
                    <input type="hidden" name="question_id" value="{{ q.id }}">
                    <input type="hidden" name="qtype" value="MCQ">
                    <input type="hidden" name="order" value="{{ q.order|default:0 }}"/>
                    <textarea name="text" class="inp" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" style="flex:1">{{ q.text }}</textarea>
                    <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                    <button type="button" class="btn cancel-edit" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„">âœ– Ø¥Ù„ØºØ§Ø¡</button>
                  </form>
                </div>

              {% else %} {# TF #}

                {# Ø¹Ø±Ø¶ (Ù‚Ø±Ø§Ø¡Ø©) â€” Ù„Ø§ Ø­ÙØ¸ Ù‡Ù†Ø§ØŒ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù„ÙˆÙ‘Ù† Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ² #}
                <div class="qview" id="qview-{{ q.id }}">
                  <div class="qtitle" style="margin-bottom:.5rem">#{{ q.id }} â€” {{ q.text|safe }}</div>
                  <div class="seg" aria-label="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©" style="margin-top:0.25rem">
                    {% if q.correct_bool is True %}
                      <button type="button" class="seg__btn ok active" disabled>ØµØ­</button>
                    {% elif q.correct_bool is False %}
                      <button type="button" class="seg__btn active" disabled>Ø®Ø·Ø£</button>
                      {% if q.correct_text %}
                        <span class="tf-correct-text">â€” {{ q.correct_text }}</span>
                      {% endif %}
                    {% else %}
                      <button type="button" class="seg__btn ok" disabled>ØµØ­</button>
                      <button type="button" class="seg__btn" disabled>Ø®Ø·Ø£</button>
                    {% endif %}
                  </div>
                </div>

                {# ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) â€” ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ âœï¸ Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© #}
                <div class="qedit" id="qedit-{{ q.id }}">
                  <form method="post" class="row" data-tf="{{ q.id }}">
                    {% csrf_token %}
                    <input type="hidden" name="form_name" value="edit_question_{{ q.id }}">
                    <input type="hidden" name="question_id" value="{{ q.id }}">
                    <input type="hidden" name="qtype" value="TF">
                    <input type="hidden" name="order" value="{{ q.order|default:0 }}">
                    <input type="hidden" name="correct_bool" id="cb-{{ q.id }}" value="{% if q.correct_bool is True %}2{% elif q.correct_bool is False %}3{% else %}{% endif %}">

                    <div style="margin-bottom:.4rem; color:var(--muted);">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„: #{{ q.id }}</div>
                    <textarea name="text" class="inp" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" style="flex:1">{{ q.text }}</textarea>

                    <div class="seg" aria-label="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©" style="margin-inline-start:0.5rem">
                      <button type="button" class="seg__btn ok {% if q.correct_bool is True %}active{% endif %}" data-target="#cb-{{ q.id }}" data-val="2">ØµØ­</button>
                      <button type="button" class="seg__btn {% if q.correct_bool is False %}active{% endif %}" data-target="#cb-{{ q.id }}" data-val="3">Ø®Ø·Ø£</button>
                    </div>

                    <div id="editCorrectText-{{ q.id }}" style="display:{% if q.correct_bool is False %}block{% else %}none{% endif %}; margin-top:.45rem">
                      <label>Ø§Ù„Ø§Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª Â«Ø®Ø·Ø£Â»)</label>
                      <input class="inp" name="correct_text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡Ù†Ø§" value="{{ q.correct_text }}">
                    </div>

                    <!-- Ø­ÙØ¸ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                    <button class="btn" type="submit" title="Ø­ÙØ¸">ğŸ’¾ Ø­ÙØ¸</button>
                    <button type="button" class="btn cancel-edit" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„">âœ– Ø¥Ù„ØºØ§Ø¡</button>
                  </form>
                </div>

              {% endif %}
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø¹Ø¯.</div>
      {% endif %}
    </section>

    <!-- ÙŠÙ…ÙŠÙ†: Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ -->
    <aside class="card">
      <h2>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h2>
      <form method="post" id="addForm">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="add_question">

        {{ qform.text }}

        <!-- Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
        <input type="hidden" name="qtype" id="qtypeHidden" value="MCQ">
        <div class="row" style="margin-top:.5rem; align-items:flex-end">
          <div style="flex:1">
            <div class="seg" id="qtypeSeg">
              <button type="button" class="seg__btn active" data-val="MCQ">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
              <button type="button" class="seg__btn" data-val="TF">ØµØ­/Ø®Ø·Ø£</button>
            </div>
          </div>

          <!-- Ø¥Ø¬Ø§Ø¨Ø© TF -->
          <div id="tfWrap" style="flex:1; display:none">
            <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
            <input type="hidden" name="correct_bool" id="addCorrectBool" value="">
            <div class="seg">
              <button type="button" class="seg__btn ok" data-target="#addCorrectBool" data-val="2">ØµØ­</button>
              <button type="button" class="seg__btn" data-target="#addCorrectBool" data-val="3">Ø®Ø·Ø£</button>
            </div>
            <div id="addCorrectText" style="display:none; margin-top:.45rem">
              <label>Ø§Ù„Ø§Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª Â«Ø®Ø·Ø£Â»)</label>
              <input class="inp" name="correct_text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡Ù†Ø§">
            </div>
          </div>
        </div>

        <!-- 3 Ø®Ø§Ù†Ø§Øª Ù„Ù„Ù…Ø®ØªØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ -->
        <div id="mcqWrap" style="display:block; margin-top:.6rem">
          <div class="row" style="align-items:flex-end">
            <div style="flex:1">
              <label>Ø§Ù„Ø®ÙŠØ§Ø± 1</label>
              <input class="inp" name="mcq_choice1" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 1">
            </div>
            <div class="seg">
              <button type="button" class="seg__btn" data-mcq-radio="1" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø± 1 ÙƒØ¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©">1</button>
            </div>
          </div>

          <div class="row" style="align-items:flex-end; margin-top:.35rem">
            <div style="flex:1">
              <label>Ø§Ù„Ø®ÙŠØ§Ø± 2</label>
              <input class="inp" name="mcq_choice2" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 2">
            </div>
            <div class="seg">
              <button type="button" class="seg__btn" data-mcq-radio="2" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø± 2 ÙƒØ¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©">2</button>
            </div>
          </div>

          <div class="row" style="align-items:flex-end; margin-top:.35rem">
            <div style="flex:1">
              <label>Ø§Ù„Ø®ÙŠØ§Ø± 3</label>
              <input class="inp" name="mcq_choice3" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø± 3 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>
            <div class="seg">
              <button type="button" class="seg__btn" data-mcq-radio="3" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø± 3 ÙƒØ¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©">3</button>
            </div>
          </div>

          <input type="hidden" name="mcq_correct" id="mcqCorrect" value="">
          <small class="muted" style="display:block; margin-top:.35rem">
            ØªÙÙ†Ø´Ø£ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„. Ø§Ù„ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.
          </small>
        </div>

        <input type="hidden" name="order" value="0">

        <div class="row" style="margin-top:.7rem">
          <button class="btn" type="submit">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„</button>
        </div>
      </form>
    </aside>
  </div>

{% endblock %}

{% block extra_js %}
  <script>
    // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø¨ÙˆØ§Ø³Ø·Ø© data-toggle (Ù„Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
    document.querySelectorAll('[data-toggle]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const el = document.querySelector(btn.getAttribute('data-toggle'));
        if(!el) return; el.style.display = (el.style.display === 'block') ? 'none' : 'block';
      });
    });

    // Ø²Ø± âœï¸ ÙÙŠ Ø±Ø£Ø³ Ø§Ù„Ø³Ø¤Ø§Ù„: ÙŠÙØªØ­ qedit ÙˆÙŠÙØ¸Ù‡Ø± Ù…Ø­Ø±Ø±Ø§Øª Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡
    document.querySelectorAll('.toggle-edit').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const card = btn.closest('.qcard');
        if (!card) return;
        const qedit = card.querySelector('.qedit');
        if (qedit) qedit.style.display = (qedit.style.display==='block') ? 'none' : 'block';
        // Ø£Ø¸Ù‡Ø±/Ø£Ø®ÙÙ ÙƒÙ„ Ù…Ø­Ø±Ø±Ø§Øª Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
        card.querySelectorAll('.optedit').forEach(el=>{
          el.style.display = qedit && qedit.style.display==='block' ? 'block' : 'none';
        });
      });
    });

    // Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø¤Ø§Ù„: Ø·ÙŠ/ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± (ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ±Ù‚Ù…Ù‡ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
    document.querySelectorAll('.qsummary').forEach(sum=>{
      sum.addEventListener('click', (e)=>{
        const card = sum.closest('.qcard'); if(!card) return;
        const expanded = card.classList.toggle('expanded');
        sum.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      });
      sum.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); sum.click(); } });
    });

    // Ø³Ù…Ø§Ø¹ Ù†Ù‚Ø±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†ÙØ³Ù‡Ø§ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø·ÙŠ/Ø§Ù„ÙØªØ­ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ.
    document.querySelectorAll('.qcard').forEach(card=>{
      card.addEventListener('click', (e)=>{
        // Ù„Ø§ Ù†ÙÙØ¹Ù„ Ø§Ù„Ø·ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡Ø¯Ù ØªÙØ¹ÙŠÙ„ÙŠÙ‹Ø§ (Ø²Ø±/Ø±Ø§Ø¨Ø·/Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„/Ù†Ù…ÙˆØ°Ø¬)
        if (e.target.closest('button, a, input, textarea, select, form')) return;
        // Ø¨Ø¯Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙŠ
        const expanded = card.classList.toggle('expanded');
        const sum = card.querySelector('.qsummary'); if(sum) sum.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      });
    });

    // ÙÙ„ØªØ±Ø© + Ø¨Ø­Ø«
    const chips = document.querySelectorAll('#typeFilters .chip');
    const list  = document.getElementById('qList');
    const search= document.getElementById('qSearch');
    let activeType = 'ALL';
    function applyFilter(){
      const q = (search?.value || '').toLowerCase().trim();
      if(!list) return;
      [...list.children].forEach(card=>{
        const t = card.getAttribute('data-type');
        const text = (card.getAttribute('data-text')||'');
        const okType = (activeType==='ALL' || t===activeType);
        const okText = (!q || text.includes(q));
        card.style.display = (okType && okText) ? '' : 'none';
      });
    }
    chips.forEach(c=>c.addEventListener('click', ()=>{
      chips.forEach(x=>x.classList.remove('active'));
      c.classList.add('active'); activeType=c.dataset.type; applyFilter();
    }));
    search?.addEventListener('input', applyFilter);

    // ØªÙ†Ù‚Ù‘Ù„ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
    const wkPrev = document.getElementById('weekPrev'),
          wkNext = document.getElementById('weekNext'),
          wkNum  = document.getElementById('weekNum');
    const maxW   = parseInt(document.querySelector('.weekctrl')?.dataset.weeks || '16', 10);
    const weekSelect = document.getElementById('weekSelect');
    const scrollKey = `wq_scroll_{{ term.id }}_{{ subject.id }}`;
    const restoreKey = `wq_restore_{{ term.id }}_{{ subject.id }}`;
    function gotoWeek(n){
      n=Math.max(1,Math.min(maxW,n));
      // Ø§Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø«Ù… Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹
      try { sessionStorage.setItem(scrollKey, String(window.scrollY || window.pageYOffset || 0)); sessionStorage.setItem(restoreKey, '1'); } catch {}
      const url=new URL(window.location.href);
      url.searchParams.set('week', String(n));
      window.location.href=url.toString();
    }
    wkPrev?.addEventListener('click', ()=> gotoWeek(parseInt(wkNum.textContent,10)-1));
    wkNext?.addEventListener('click', ()=> gotoWeek(parseInt(wkNum.textContent,10)+1));
    weekSelect?.addEventListener('change', ()=> gotoWeek(parseInt(weekSelect.value, 10)));

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
    (function restoreScroll(){
      try {
        const should = sessionStorage.getItem(restoreKey) === '1';
        const v = parseInt(sessionStorage.getItem(scrollKey) || '0', 10);
        if (should && !isNaN(v)) {
          window.scrollTo({ top: v, behavior: 'instant' });
        }
        sessionStorage.removeItem(restoreKey);
      } catch {}
    })();

    // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø°Ø§Øª data-target (TF ÙÙ‚Ø·)
    function bindSegToHidden(root) {
      root.querySelectorAll('.seg__btn[data-val][data-target]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const targetSel = btn.getAttribute('data-target');
          const hidden = document.querySelector(targetSel);
          if (!hidden) return;
          btn.parentElement.querySelectorAll('.seg__btn[data-target]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          hidden.value = btn.getAttribute('data-val'); // 2/3
        });
      });
    }
    document.querySelectorAll('form[data-tf]').forEach(f=>bindSegToHidden(f));
    const tfWrap = document.getElementById('tfWrap'); if (tfWrap) bindSegToHidden(tfWrap);

    // Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ­Ø±ÙŠØ±: Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø®Ø·Ø£" Ø¯Ø§Ø®Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ­Ø±ÙŠØ±
    document.querySelectorAll('form[data-tf]').forEach(f=>{
      const hid = f.querySelector('input[name="correct_bool"]');
      const qid = f.getAttribute('data-tf');
      const textWrap = document.getElementById('editCorrectText-' + qid);
      if (!hid || !textWrap) return;
      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
      (function(){ if (hid.value === '3') { textWrap.style.display=''; const inp = textWrap.querySelector('input'); if(inp) inp.setAttribute('required','required'); } else { textWrap.style.display='none'; const inp = textWrap.querySelector('input'); if(inp){ inp.removeAttribute('required'); } }})();
      // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø±
      f.querySelectorAll('.seg__btn[data-val]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const v = btn.getAttribute('data-val');
          if (v === '3') { textWrap.style.display=''; const inp = textWrap.querySelector('input'); if(inp) inp.setAttribute('required','required'); }
          else { textWrap.style.display='none'; const inp = textWrap.querySelector('input'); if(inp){ inp.removeAttribute('required'); inp.value=''; } }
        });
      });
    });

    // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ÙŠØ®ÙÙŠ Ù…Ø­Ø±Ø± Ø§Ù„Ø®ÙŠØ§Ø±/Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.querySelectorAll('.cancel-edit').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const form = btn.closest('form');
        const optedit = btn.closest('.optedit');
        const qedit = btn.closest('.qedit');
        // Ø£Ø®ÙÙ Ø§Ù„Ù…Ø­Ø±Ù‘Ø± Ø§Ù„Ù‚Ø±ÙŠØ¨
        if (optedit) optedit.style.display = 'none';
        if (qedit) {
          qedit.style.display = 'none';
          // ÙˆØ£Ø®ÙÙ Ù…Ø­Ø±Ù‘Ø±Ø§Øª Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
          const card = btn.closest('.qcard');
          if (card) card.querySelectorAll('.optedit').forEach(o=>o.style.display='none');
        }
        // Ø£Ø²Ù„ Ø³Ù…Ø§Øª required Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø®ÙÙŠ Ù„ØªØ¬Ù†Ù‘Ø¨ Ù…Ø´Ø§ÙƒÙ„ ØªØ­Ù‚Ù‚ Ù„Ø§Ø­Ù‚Ù‹Ø§
        if (form) {
          form.querySelectorAll('[required]').forEach(i=>i.removeAttribute('required'));
        }
      });
    });

    // Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ TF: Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø®Ø·Ø£"
    const addCorrectText = document.getElementById('addCorrectText');
    if (tfWrap && addCorrectText) {
      tfWrap.querySelectorAll('.seg__btn[data-val]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const v = btn.getAttribute('data-val');
          if (v === '3') {
            addCorrectText.style.display = '';
            const inp = addCorrectText.querySelector('input'); if (inp) inp.setAttribute('required','required');
          } else {
            addCorrectText.style.display = 'none';
            const inp = addCorrectText.querySelector('input'); if (inp) { inp.removeAttribute('required'); inp.value = ''; }
          }
        });
      });
    }

    // Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„ + Ù…ØªØ·Ù„Ø¨Ø§Øª MCQ
    const addForm        = document.getElementById('addForm');
    const qtypeSeg       = document.getElementById('qtypeSeg');
    const qtypeHidden    = document.getElementById('qtypeHidden');
    const mcqWrap        = document.getElementById('mcqWrap');
    const addCorrectBool = document.getElementById('addCorrectBool');
    const mcqInputs = ['mcq_choice1','mcq_choice2','mcq_choice3'].map(n => addForm?.querySelector(`[name="${n}"]`));

    function setMCQRequirements(enable){
      mcqInputs.forEach((inp, idx)=>{
        if(!inp) return;
        if(enable){
          inp.removeAttribute('disabled');
          if(idx<2) inp.setAttribute('required','required'); else inp.removeAttribute('required');
        }else{
          inp.setAttribute('disabled','disabled'); inp.removeAttribute('required');
        }
      });
    }
    qtypeSeg?.querySelectorAll('.seg__btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qtypeSeg.querySelectorAll('.seg__btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const v = btn.dataset.val;
        qtypeHidden.value = v;
        if (v === 'TF'){
          tfWrap.style.display=''; mcqWrap.style.display='none'; setMCQRequirements(false);
        } else {
          tfWrap.style.display='none'; mcqWrap.style.display=''; setMCQRequirements(true);
          if(addCorrectBool) addCorrectBool.value='';
        }
      });
    });

    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ MCQ
    const mcqCorrect = document.getElementById('mcqCorrect');
    document.querySelectorAll('[data-mcq-radio]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('[data-mcq-radio]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        mcqCorrect.value = btn.getAttribute('data-mcq-radio');
      });
    });

    // Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ©
    (function ini(){
      if (qtypeHidden?.value === 'TF'){
        tfWrap.style.display=''; mcqWrap.style.display='none'; setMCQRequirements(false);
      } else {
        tfWrap.style.display='none'; mcqWrap.style.display=''; setMCQRequirements(true);
      }
    })();

    // ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    const weekNum = "{{ week.number }}";
    function norm(s){ return (s||'').toString().trim(); }
    function normKey(s){ return norm(s).toLowerCase().replace(/\s+/g,' '); }

    // ØªØ­ÙˆÙŠÙ„ 2/3 â†’ on/off ÙÙŠ Ø¥Ø¶Ø§ÙØ© TF
    addForm?.addEventListener('submit', (e)=>{
      if (qtypeHidden.value === 'TF') {
        setMCQRequirements(false);
        const vRaw = addCorrectBool?.value;
        if (vRaw !== '2' && vRaw !== '3') { e.preventDefault(); alert('Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Â«ØµØ­Â» Ø£Ùˆ Â«Ø®Ø·Ø£Â».'); return; }
        // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ on/off Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù†ØµÙˆØµ Ø­Ø±ÙÙŠØ©
        addCorrectBool.value = (vRaw === '2') ? 'on' : 'off';
        localStorage.removeItem('pending_mcq_options');
      } else {
        setMCQRequirements(true);
        const t  = addForm.querySelector('[name="text"]');
        const c1 = addForm.querySelector('[name="mcq_choice1"]')?.value || '';
        const c2 = addForm.querySelector('[name="mcq_choice2"]')?.value || '';
        const c3 = addForm.querySelector('[name="mcq_choice3"]')?.value || '';
        const sel= mcqCorrect?.value || '';
        const nonEmpty = [c1,c2,c3].map(norm).filter(Boolean);
        if (!norm(t?.value) || nonEmpty.length < 2 || !['1','2','3'].includes(sel)) {
          e.preventDefault(); alert('Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª: Ø£Ø¯Ø®Ù„ Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ­Ø¯Ù‘Ø¯ Ø§Ù„ØµØ­ÙŠØ­.'); return;
        }
      }
    }, true);

    // ØªØ­ÙˆÙŠÙ„ 2/3 â†’ on/off ÙÙŠ ØªØ­Ø±ÙŠØ± TF
    document.querySelectorAll('form[data-tf]').forEach(f=>{
      f.addEventListener('submit', ()=>{
        const hid = f.querySelector('input[name="correct_bool"]');
        if (!hid) return;
        const vRaw = hid.value;
        if (vRaw === '2') hid.value = 'on';
        else if (vRaw === '3') hid.value = 'off';
      }, true);
    });

  </script>
{% endblock %}
