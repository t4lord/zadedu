
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ lesson.title }} â€” Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø³</title>
  <style>
    body{font-family:system-ui,Tahoma; margin:2rem;}
    .header{display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap}
    .badge{display:inline-block; background:#eef; border:1px solid #dde; padding:.25rem .6rem; border-radius:8px; font-size:.9rem}
    .btn{padding:.5rem .8rem; border-radius:10px; border:1px solid #ccc; text-decoration:none; display:inline-block; cursor:pointer}
    .btn:hover{background:#f7f7f7}
    .card{border:1px solid #ddd; border-radius:12px; padding:1rem; margin-top:1rem}
    .toolbar{display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.6rem}
    .hidden{display:none}
    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„ØªØ­Ø±ÙŠØ± */
    #viewer{line-height:1.9}
    #editor{line-height:1.9; min-height:200px; border:1px dashed #bbb; padding:1rem; border-radius:10px}
    /* Ø²Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯Ø±Ø³ (Ø¹Ø§Ø¦Ù…) */
    .fab{
      position: fixed; left: 1.2rem; bottom: 1.2rem;
      width: 48px; height: 48px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      border: 1px solid #ccc; background:#fff; text-decoration:none; font-size:1.2rem;
      box-shadow: 0 4px 16px rgba(0,0,0,.08);
    }
    .fab:hover{background:#f7f7f7}
  </style>
</head>
<body>
  <div class="header">
    <div>
      <span class="badge">Ø§Ù„Ø³Ù†Ø©: {{ term.year }}</span>
      <span class="badge">Ø§Ù„ÙØµÙ„: {{ term.get_number_display }}</span>
      <span class="badge">Ø§Ù„Ù…Ø§Ø¯Ø©: {{ subject.name }}</span>
    </div>
    <div>
      <a class="btn" href="{% url 'lessons_list' term.id subject.id %}">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø±ÙˆØ³</a>
      <!-- ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ± -->
      <button class="btn" id="editToggleBtn" type="button">âœï¸ ØªØ­Ø±ÙŠØ±</button>
    </div>
  </div>

  <h1>{{ lesson.title }}</h1>

  <div class="card">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙŠØ¸Ù‡Ø± ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ± ÙÙ‚Ø· -->
    <div class="toolbar hidden" id="toolbar">
      <button class="btn" type="button" id="boldBtn"><strong>B</strong></button>
      <button class="btn" type="button" id="cleanBtn">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª</button>
      <form method="post" id="saveForm" style="display:inline">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="save_content"/>
        <input type="hidden" name="body_html" id="bodyHtmlInput"/>
        <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn" type="button" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </form>
    </div>

    <!-- ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ -->
    <div id="viewer">
      {% if content and content.body %}
        <div id="viewerHtml">{{ content.body|safe }}</div>
      {% else %}
        <em>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù†ØµÙ‘ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø¹Ø¯.</em>
      {% endif %}
    </div>

    <!-- ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ± (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§) -->
    <div id="editorWrap" class="hidden">
      <div id="editor" contenteditable="true"></div>
      <small style="color:#666;display:block;margin-top:.4rem">
        ØªÙ„Ù…ÙŠØ­: Ø­Ø¯Ù‘Ø¯ Ù†ØµÙ‹Ø§ Ø«Ù… Ø§Ø¶ØºØ· <strong>B</strong> Ù„Ø¹Ù…Ù„Ù‡ Ø¹Ø±ÙŠØ¶Ù‹Ø§. Ø²Ø± ğŸ§¹ ÙŠØ²ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆÙŠØ³ØªØ¨Ø¯Ù„ &nbsp; Ø¨Ù…Ø³Ø§ÙØ§Øª Ø¹Ø§Ø¯ÙŠØ©.
      </small>
    </div>
  </div>

  <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯Ø±Ø³ -->
  <a class="fab" href="{% url 'lesson_questions' term.id subject.id lesson.id %}" title="Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯Ø±Ø³">â“</a>

  <script>
    const editToggleBtn = document.getElementById('editToggleBtn');
    const toolbar       = document.getElementById('toolbar');
    const viewer        = document.getElementById('viewer');
    const viewerHtml    = document.getElementById('viewerHtml');
    const editorWrap    = document.getElementById('editorWrap');
    const editor        = document.getElementById('editor');
    const bodyHtmlInput = document.getElementById('bodyHtmlInput');
    const saveForm      = document.getElementById('saveForm');
    const boldBtn       = document.getElementById('boldBtn');
    const cleanBtn      = document.getElementById('cleanBtn');
    const cancelBtn     = document.getElementById('cancelBtn');

    let snapshotHtml = '';

    function enterEdit() {
      snapshotHtml = viewerHtml ? viewerHtml.innerHTML : '';
      editor.innerHTML = snapshotHtml;
      viewer.classList.add('hidden');
      editorWrap.classList.remove('hidden');
      toolbar.classList.remove('hidden');
      editToggleBtn.disabled = true;
    }

    function exitEdit(discard=false) {
      if (!discard) {
        // Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ØŒ Ø§Ù„ØµÙØ­Ø© ØªÙØ¹Ø§Ø¯ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù€ redirect
      } else {
        // Ø¥Ù„ØºØ§Ø¡: Ø§Ø±Ø¬Ø¹ Ù„Ù…Ø§ ÙƒØ§Ù†
        editor.innerHTML = snapshotHtml;
      }
      viewer.classList.remove('hidden');
      editorWrap.classList.add('hidden');
      toolbar.classList.add('hidden');
      editToggleBtn.disabled = false;
    }

    editToggleBtn?.addEventListener('click', enterEdit);
    cancelBtn?.addEventListener('click', () => exitEdit(true));

    // Bold Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (execCommand Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ ÙƒØ±ÙˆÙ…ÙŠÙˆÙ…)
    boldBtn?.addEventListener('click', () => {
      editor.focus();
      document.execCommand('bold', false, null);
    });

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª: ÙŠØ­ÙˆÙ‘Ù„ &nbsp; Ù„Ù…Ø³Ø§ÙØ©ØŒ ÙˆÙŠÙÙ‚Ù„Ù‘Øµ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©ØŒ ÙˆÙŠØ²ÙŠÙ„ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© Ø­ÙˆÙ„ Ø§Ù„ÙˆØ³ÙˆÙ…
    cleanBtn?.addEventListener('click', () => {
      const html = editor.innerHTML
        .replace(/&nbsp;/g, ' ')
        .replace(/\s{2,}/g, ' ')
        .replace(/>\s+/g, '>')
        .replace(/\s+</g, '<')
        .trim();
      editor.innerHTML = html;
    });

    // Ø­ÙØ¸: Ø§Ù†Ø³Ø® HTML Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ù‘Ø± Ø¥Ù„Ù‰ Ø­Ù‚Ù„ Ù…Ø®ÙÙŠ ÙˆØ§Ø±Ø³ÙÙ„
    saveForm?.addEventListener('submit', (e) => {
      bodyHtmlInput.value = editor.innerHTML.trim();
      // ÙŠÙÙƒÙ…Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø§Ø¯ÙŠØŒ ÙˆØ¨Ø¹Ø¯Ù‡ view Ø³ÙŠØ¹Ù…Ù„ redirect Ù„Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø©
    });
  </script>
</body>
</html>
