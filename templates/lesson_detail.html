{% extends "base.html" %}
{% block title %}{{ lesson.title }} â€” Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø³{% endblock %}
{% block extra_css %}
  <style>
    .header{display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap}
    .badge{display:inline-block; background:#eef; border:1px solid #dde; padding:.25rem .6rem; border-radius:8px; font-size:.9rem}
    .btn{padding:.5rem .8rem; border-radius:10px; border:1px solid #ccc; text-decoration:none; display:inline-block; cursor:pointer}
    .btn:hover{background:#f7f7f7}
    .card{border:1px solid #ddd; border-radius:12px; padding:1rem; margin-top:1rem}
    .toolbar{display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.6rem}
    .hidden{display:none}
    #viewer{line-height:1.9}
    #editor{line-height:1.9; min-height:200px; border:1px dashed #bbb; padding:1rem; border-radius:10px}
    /* Ø£Ø²ÙŠÙ„ Ø²Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø¹Ø§Ø¦Ù… Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ø¶Ù…Ù† Ø§Ù„ØªÙ†Ø¸ÙŠÙ */
  </style>
{% endblock %}

{% block content %}
  <div class="header">
    <div>
      <span class="badge">Ø§Ù„Ø³Ù†Ø©: {{ term.year }}</span>
      <span class="badge">Ø§Ù„ÙØµÙ„: {{ term.get_number_display }}</span>
      <span class="badge">Ø§Ù„Ù…Ø§Ø¯Ø©: {{ subject.name }}</span>
    </div>
    <div>
      <a class="btn" href="{% url 'lessons_list' term.id subject.id %}">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø±ÙˆØ³</a>
      <button class="btn" id="editToggleBtn" type="button">âœï¸ ØªØ­Ø±ÙŠØ±</button>
    </div>
  </div>

  <h1>{{ lesson.title }}</h1>

  <div class="card">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙŠØ¸Ù‡Ø± ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ± ÙÙ‚Ø· -->
    <div class="toolbar hidden" id="toolbar">
      <button class="btn" type="button" id="boldBtn"><strong>B</strong></button>
      <button class="btn" type="button" id="cleanBtn">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª</button>
      <form method="post" id="saveForm" action="">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="save_content"/>
        <input type="hidden" name="body_html" id="bodyHtmlInput"/>
        <button class="btn" type="submit">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn" type="button" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </form>
    </div>

    <!-- ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ -->
    <div id="viewer">
      {% if content and content.body %}
        <div id="viewerHtml">{{ content.body|safe }}</div>
      {% else %}
        <em>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù†ØµÙ‘ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø¹Ø¯.</em>
      {% endif %}
    </div>

    <!-- ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ± (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§) -->
    <div id="editorWrap" class="hidden">
      <div id="editor" contenteditable="true"></div>
      <small style="color:#666;display:block;margin-top:.4rem">
        ØªÙ„Ù…ÙŠØ­: Ø­Ø¯Ù‘Ø¯ Ù†ØµÙ‹Ø§ Ø«Ù… Ø§Ø¶ØºØ· <strong>B</strong> Ù„Ø¹Ù…Ù„Ù‡ Ø¹Ø±ÙŠØ¶Ù‹Ø§. Ø²Ø± ğŸ§¹ ÙŠØ²ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙˆÙŠØ³ØªØ¨Ø¯Ù„ &nbsp; Ø¨Ù…Ø³Ø§ÙØ§Øª Ø¹Ø§Ø¯ÙŠØ©.
      </small>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
  <script>
    const editToggleBtn = document.getElementById('editToggleBtn');
    const toolbar       = document.getElementById('toolbar');
    const viewer        = document.getElementById('viewer');
    const viewerHtml    = document.getElementById('viewerHtml'); // Ù‚Ø¯ Ù„Ø§ ÙŠÙˆØ¬Ø¯
    const editorWrap    = document.getElementById('editorWrap');
    const editor        = document.getElementById('editor');
    const bodyHtmlInput = document.getElementById('bodyHtmlInput');
    const saveForm      = document.getElementById('saveForm');
    const boldBtn       = document.getElementById('boldBtn');
    const cleanBtn      = document.getElementById('cleanBtn');
    const cancelBtn     = document.getElementById('cancelBtn');

    let snapshotHtml = '';

    function currentViewerHTML() {
      // Ø®Ø° HTML Ù…Ù† viewerHtml Ø¥Ù† ÙˆØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ù…Ù† #viewer ÙƒÙ„Ù‡ (Ø¨Ø¯ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª)
      if (viewerHtml) return viewerHtml.innerHTML;
      // Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ Ù…Ø­ØªÙˆÙ‰ØŒ Ø§Ø±Ø¬Ø¹ Ø³Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ© Ø¨Ø¯Ù„ Ø±Ø³Ø§Ù„Ø© <em> Ø¹Ø´Ø§Ù† Ù…Ø§ ØªÙØ­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ†Øµ
      return '';
    }

    function enterEdit() {
      snapshotHtml = currentViewerHTML();
      editor.innerHTML = snapshotHtml;
      viewer.classList.add('hidden');
      editorWrap.classList.remove('hidden');
      toolbar.classList.remove('hidden');
      editToggleBtn.disabled = true;
      editor.focus();
    }

    function exitEdit(discard=false) {
      if (discard) {
        editor.innerHTML = snapshotHtml;
      }
      viewer.classList.remove('hidden');
      editorWrap.classList.add('hidden');
      toolbar.classList.add('hidden');
      editToggleBtn.disabled = false;
    }

    editToggleBtn?.addEventListener('click', enterEdit);
    cancelBtn?.addEventListener('click', () => exitEdit(true));

    // Bold Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (execCommand Ù…Ø§ Ø²Ø§Ù„ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ ÙƒØ±ÙˆÙ…ÙŠÙˆÙ…)
    boldBtn?.addEventListener('click', () => {
      editor.focus();
      document.execCommand('bold', false, null);
    });

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª: ÙŠØ­ÙˆÙ‘Ù„ &nbsp; Ù„Ù…Ø³Ø§ÙØ©ØŒ ÙŠÙ‚Ù„Ù‘Øµ Ø§Ù„Ù…ÙƒØ±Ù‘Ø±ØŒ ÙŠØ²ÙŠÙ„ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø­ÙˆÙ„ Ø§Ù„ÙˆØ³ÙˆÙ…
    cleanBtn?.addEventListener('click', () => {
      const html = editor.innerHTML
        .replace(/&nbsp;/g, ' ')
        .replace(/\s{2,}/g, ' ')
        .replace(/>\s+/g, '>')
        .replace(/\s+</g, '<')
        .trim();
      editor.innerHTML = html;
    });

    // Ø­ÙØ¸: Ø§Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§Ø±Øº ÙˆØºÙŠØ± Ø§Ù„Ù…ØªØºÙŠÙ‘Ø±
    saveForm?.addEventListener('submit', (e) => {
      const newHtml = editor.innerHTML.trim();
      if (newHtml === snapshotHtml.trim()) {
        // Ù„Ø§ ØªØºÙŠÙŠØ±Ø§ØªØ› Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        // e.preventDefault();
        // return;
      }
      bodyHtmlInput.value = newHtml;
    });
  </script>
{% endblock %}
