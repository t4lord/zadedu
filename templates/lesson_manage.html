{% extends "base.html" %}
{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±Ø³ â€” {{ lesson.title }}{% endblock %}
{% block extra_css %}
  <style>
    :root { --bg:#fff; --bd:#e7e7e7; --muted:#666; --ink:#111; --pill:#eef; --pillbd:#dde; }
    body{font-family:system-ui,Tahoma; margin:2rem; color:var(--ink); background:var(--bg)}
    .mngr__head{display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap}
    .badge{display:inline-block; background:var(--pill); border:1px solid var(--pillbd); padding:.25rem .6rem; border-radius:8px; font-size:.9rem; margin-inline-end:.25rem}
    .btn{padding:.5rem .8rem; border-radius:10px; border:1px solid #ccc; text-decoration:none; display:inline-block; cursor:pointer; background:#fff}
    .btn:hover{background:#f7f7f7}
    .card{border:1px solid var(--bd); border-radius:14px; padding:1rem; background:var(--bg)}
    .mngr__grid{display:grid; gap:1rem; grid-template-columns: 1fr; margin-top:1rem}
    .inp{width:100%; padding:.6rem .7rem; border:1px solid #ccc; border-radius:10px}
    .row{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center}
    .muted{color:var(--muted)}
    h1{margin:.6rem 0 0 0}
    h2{margin:0 0 .6rem 0; font-size:1.1rem}

    /* Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.6rem}
    .toolbar .btn{cursor:pointer}
    #m_editor{line-height:1.9; min-height:220px; border:1px dashed #bbb; padding:1rem; border-radius:10px; background:#fff;}
    #m_editor ul, #m_editor ol { padding-inline-start: 1.25rem; }
    #m_editor p { margin: .2rem 0; }

    /* Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ø«Ø§Ø¨ØªØ© */
    .palette{display:flex; gap:.4rem; align-items:center; flex-wrap:wrap}
    .sw{
      width:24px; height:24px; border-radius:50%;
      border:1px solid #bbb; cursor:pointer; display:inline-block;
    }
    .sw:focus{outline:2px solid #999}
  </style>
{% endblock %}

{% block content %}
  <div class="mngr__head">
    <div>
      <span class="badge">Ø§Ù„Ø³Ù†Ø©: {{ term.year }}</span>
      <span class="badge">Ø§Ù„ÙØµÙ„: {{ term.get_number_display }}</span>
      <span class="badge">Ø§Ù„Ù…Ø§Ø¯Ø©: {{ subject.name }}</span>
      <span class="badge">Ø§Ù„Ø¯Ø±Ø³: {{ lesson.title }}</span>
    </div>
    <div class="row">
      <a class="btn" href="{% url 'lessons_list' term.id subject.id %}">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ø±ÙˆØ³</a>
    </div>
  </div>

  <h1>{{ lesson.title }}</h1>

  <div class="mngr__grid">
    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³ ÙÙ‚Ø· -->
<section class="card card--with-side-toolbar">
  <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø£ÙŠÙ…Ù†ØŒ Ø¹Ù…ÙˆØ¯ÙŠ ÙˆÙ„Ø§ØµÙ‚ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠØ± -->
  <style>
    .card.card--with-side-toolbar { display: flow-root; position: relative; padding-inline-end: 2rem; }
    .toolbar--side {
      position: sticky;
      top: 3rem;
      float: right; /* ÙŠÙ…ÙŠÙ† */
      margin-left: 1rem;
      display: flex;
      flex-direction: column; /* Ø¹Ù…ÙˆØ¯ÙŠ */
      gap: .35rem;
      align-items: center;
      padding: .2rem;
      background: rgba(255,255,255,.95);
      border: 1px solid #ddd;
      border-radius: .5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      z-index: 10;
      width: 2.5rem; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ù„ÙŠØªØ³Ø¹ Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ù„ÙˆØ­Ø© */
    }
    .toolbar--side .btn { font-size: 12px; width: 16px; height: 36px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .toolbar--side .palette { display: flex; flex-wrap: wrap; align-items: center; gap: .3rem; font-size: 12px; justify-content: center; }
    .toolbar--side .palette .muted { display:none; }
    .toolbar--side .sw { width: 10px; height: 18px; border: 1px solid #ccc; border-radius: 3px; padding: 0; }
    /* Ø£Ø®ÙÙ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø§Ø¦Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆÙØ¬Ø¯ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± */
    .toolbar--floating { display: none !important; }
  </style>
      <h2>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³: {{ lesson.title }}</h2>

      <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
<div class="toolbar toolbar--floating" role="toolbar" aria-label="Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±" style="position:fixed; inset-inline-end:1rem; top:1rem; z-index:1040; display:flex; gap:.4rem; align-items:center; flex-wrap:wrap; padding:.25rem .5rem; background:rgba(255,255,255,.9); border:1px solid #ddd; border-radius:.5rem; box-shadow:0 2px 8px rgba(0,0,0,.08); font-size:12px;">
        <button class="btn" type="button" id="m_bold"><strong>B</strong></button>
        <button class="btn" type="button" id="m_ul">â€¢ Ù‚Ø§Ø¦Ù…Ø©</button>
        <button class="btn" type="button" id="m_ol">1. ØªØ¹Ø¯Ø§Ø¯</button>

        <!-- Ù„ÙˆØ­Ø© Ø£Ù„ÙˆØ§Ù† Ø«Ø§Ø¨ØªØ© -->
        <div class="palette" aria-label="Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Øµ">
          <span class="muted">Ø§Ù„Ù„ÙˆÙ†:</span>
          <button class="sw" data-color="#000000" title="Ø£Ø³ÙˆØ¯" style="background:#000000"></button>
          <button class="sw" data-color="#d10000" title="Ø£Ø­Ù…Ø±" style="background:#d10000"></button>
          <button class="sw" data-color="#0057d1" title="Ø£Ø²Ø±Ù‚" style="background:#0057d1"></button>
          <button class="sw" data-color="#17823a" title="Ø£Ø®Ø¶Ø±" style="background:#17823a"></button>
        </div>

        <button class="btn" type="button" id="m_clean">ğŸ§¹ ØªÙ†Ø¸ÙŠÙ</button>
        <button class="btn" type="submit" form="contentForm">ğŸ’¾ Ø­ÙØ¸</button>
      </div>

<!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†ÙŠ ÙÙŠ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø£ÙŠÙ…Ù†ØŒ Ø¹Ù…ÙˆØ¯ÙŠ ÙˆÙ„Ø§ØµÙ‚ -->
<style>
  /* Ø¶Ø¨Ø· Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø¥ØªØ§Ø­Ø© Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
  .toolbar--side + form#contentForm { margin-right: 8rem; margin-inline-end: 8rem; }
  /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ· */
  .toolbar--side { width: 2.5rem; }
  .toolbar--side .btn { width: 32px; height: 32px; font-size: 12px; }
  /* Ø¬Ø¹Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¹Ù…ÙˆØ¯ÙŠØ© */
  .toolbar--side .palette { flex-direction: column; flex-wrap: nowrap; gap: .4rem; }
  .toolbar--side .sw { width: 20px; height: 20px; }
  /* Ø²Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
  .toolbar--side .btn--mic { background:#f8f9fa; border:1px solid #d0d7de; border-radius: 6px; }
  .toolbar--side .btn--mic.recording { background:#dc3545; color:#fff; border-color:#dc3545; box-shadow: 0 0 0 2px rgba(220,53,69,.2) inset; }
  .toolbar--side .stt-status { text-align:center; font-size: 11px; color:#666; }
  .toolbar--side .stt-preview { font-size: 11px; color:#333; max-height: 4.5rem; overflow:auto; direction: rtl; text-align: right; }
</style>
<div class="toolbar toolbar--side" role="toolbar" aria-label="Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±">
  <button class="btn btn--mic" type="button" id="m_stt" title="Ø¥Ù…Ù„Ø§Ø¡ ØµÙˆØªÙŠ (Ø¹Ø±Ø¨ÙŠ)" aria-label="Ø¥Ù…Ù„Ø§Ø¡ ØµÙˆØªÙŠ"><span aria-hidden="true">ğŸ¤</span></button>
  <div class="stt-status" aria-live="polite">
    <div id="stt_state">Ø¬Ø§Ù‡Ø²</div>
    <div id="stt_preview" class="stt-preview"></div>
  </div>
  <button class="btn" type="button" id="m_bold" title="Ø¹Ø±ÙŠØ¶" aria-label="Ø¹Ø±ÙŠØ¶"><span aria-hidden="true"><b>B</b></span></button>
  <button class="btn" type="button" id="m_ul" title="Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø·ÙŠØ©" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‚Ø·ÙŠØ©"><span aria-hidden="true">â€¢</span></button>
  <button class="btn" type="button" id="m_ol" title="ØªØ¹Ø¯Ø§Ø¯ Ø±Ù‚Ù…ÙŠ" aria-label="ØªØ¹Ø¯Ø§Ø¯ Ø±Ù‚Ù…ÙŠ"><span aria-hidden="true">1</span></button>

  <div class="palette" aria-label="Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Øµ">
    <button class="sw" data-color="#000000" title="Ø£Ø³ÙˆØ¯" aria-label="Ø£Ø³ÙˆØ¯" style="background:#000000"></button>
    <button class="sw" data-color="#d10000" title="Ø£Ø­Ù…Ø±" aria-label="Ø£Ø­Ù…Ø±" style="background:#d10000"></button>
    <button class="sw" data-color="#0057d1" title="Ø£Ø²Ø±Ù‚" aria-label="Ø£Ø²Ø±Ù‚" style="background:#0057d1"></button>
    <button class="sw" data-color="#17823a" title="Ø£Ø®Ø¶Ø±" aria-label="Ø£Ø®Ø¶Ø±" style="background:#17823a"></button>
  </div>

  <button class="btn" type="button" id="m_clean" title="ØªÙ†Ø¸ÙŠÙ" aria-label="ØªÙ†Ø¸ÙŠÙ"><span aria-hidden="true">ğŸ§¹</span></button>
  <button class="btn" type="submit" form="contentForm" title="Ø­ÙØ¸" aria-label="Ø­ÙØ¸"><span aria-hidden="true">ğŸ’¾</span></button>
</div>

<script>
  // Speech-to-Text (Arabic) using Web Speech API
  document.addEventListener('DOMContentLoaded', function () {
    var micBtn = document.getElementById('m_stt');
    if (!micBtn) return;
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      micBtn.disabled = true;
      micBtn.title = 'Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙˆØªÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­';
      return;
    }

    var recognition = new SpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.continuous = true;
    recognition.interimResults = true; // Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯Ø«
    recognition.maxAlternatives = 1;

    var active = false;

    function getEditorEl() {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù†ØµØ± Ù…Ø±ÙƒÙ‘Ø² ÙˆÙ‡Ùˆ Ù…Ø­Ø±Ø± Ù†ØµÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
      var a = document.activeElement;
      if (a && (a.tagName === 'TEXTAREA' || a.tagName === 'INPUT' || a.isContentEditable)) return a;
      // Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹
      var marked = document.querySelector('#contentForm [data-editor]');
      if (marked) return marked;
      // Ø­Ø§ÙˆÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ Ù…Ø±Ø´Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      var form = document.getElementById('contentForm') || document;
      var candidates = Array.from(form.querySelectorAll('textarea, [contenteditable="true"], input[type="text"][name]'));
      if (!candidates.length) return null;
      // Ø£Ø¹Ø·Ù Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø§Ø³Ù…/Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ content/body/text/html
      function score(el) {
        var s = 0;
        var n = (el.getAttribute('name') || '') + ' ' + (el.id || '') + ' ' + (el.className || '');
        if (/content|body|text|html/i.test(n)) s += 5;
        var rect = el.getBoundingClientRect();
        s += Math.round((rect.width * rect.height) / 10000);
        if (el.tagName === 'TEXTAREA' || el.isContentEditable) s += 2;
        return s;
      }
      candidates.sort(function(a,b){ return score(b) - score(a); });
      var best = candidates[0];
      if (best) best.setAttribute('data-editor','1');
      return best || null;
    }
    // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
    var targetEl = null;
    var anchorNode = null; // Ù„Ù…Ø­Ø±Ø±Ø§Øª contenteditable
    var committedLen = 0; // Ø·ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬Ù‡ ÙØ¹Ù„Ø§Ù‹

    function placeAnchorForContentEditable(el) {
      var sel = window.getSelection();
      var r = null;
      if (sel && sel.rangeCount && el.contains(sel.getRangeAt(0).commonAncestorContainer)) {
        r = sel.getRangeAt(0).cloneRange();
      } else {
        r = document.createRange();
        r.selectNodeContents(el);
        r.collapse(false);
      }
      anchorNode = document.createElement('span');
      anchorNode.id = 'stt-anchor-' + Date.now();
      anchorNode.style.display = 'inline';
      anchorNode.style.width = '0';
      anchorNode.style.height = '0';
      r.insertNode(anchorNode);
    }

    function cleanupAnchor() {
      if (anchorNode && anchorNode.parentNode) {
        anchorNode.parentNode.removeChild(anchorNode);
      }
      anchorNode = null;
    }

    function insertDeltaText(delta) {
      if (!delta) return;
      if (!targetEl) return;
      if (targetEl.isContentEditable) {
        var textNode = document.createTextNode(delta);
        if (anchorNode && anchorNode.parentNode) {
          anchorNode.parentNode.insertBefore(textNode, anchorNode);
        } else {
          targetEl.appendChild(textNode);
        }
        // Ø­Ø±Ù‘Ùƒ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„
        var sel = window.getSelection();
        if (sel) {
          var range = document.createRange();
          range.setStartAfter(textNode);
          range.setEndAfter(textNode);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      } else if (targetEl.tagName === 'TEXTAREA' || targetEl.tagName === 'INPUT') {
        var start = targetEl.selectionStart != null ? targetEl.selectionStart : targetEl.value.length;
        var end = targetEl.selectionEnd != null ? targetEl.selectionEnd : targetEl.value.length;
        var before = targetEl.value.slice(0, start);
        var after = targetEl.value.slice(end);
        targetEl.value = before + delta + after;
        var caret = before.length + delta.length;
        targetEl.selectionStart = targetEl.selectionEnd = caret;
        targetEl.dispatchEvent(new Event('input', { bubbles: true }));
        committedLen += delta.length;
        return;
      }
      committedLen += delta.length;
    }

    recognition.onresult = function (event) {
      // Ø§Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      var fullText = '';
      for (var i = 0; i < event.results.length; i++) {
        var res = event.results[i];
        var transcript = res[0] && res[0].transcript ? res[0].transcript : '';
        fullText += transcript + (res.isFinal ? ' ' : '');
      }
      // Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ù…Ù†Ø° Ø¢Ø®Ø± Ù…Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡
      if (fullText.length > committedLen) {
        var delta = fullText.slice(committedLen);
        insertDeltaText(delta);
      }
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø©
      try {
        var stateEl = document.getElementById('stt_state');
        var prevEl = document.getElementById('stt_preview');
        if (stateEl) stateEl.textContent = 'ÙŠØ³Ø¬Ù‘Ù„â€¦';
        if (prevEl) prevEl.textContent = fullText;
      } catch(_){}
    };

    recognition.onerror = function (e) {
      stop();
      if (e && e.error) {
        var msg = '';
        switch (e.error) {
          case 'no-speech': msg = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØª. Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ø¯Ø« Ø¨ÙˆØ¶ÙˆØ­.'; break;
          case 'audio-capture': msg = 'ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.'; break;
          case 'not-allowed': msg = 'ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. Ø§Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.'; break;
          case 'network': msg = 'Ù…Ø´ÙƒÙ„Ø© Ø´Ø¨ÙƒØ©. ÙŠØªØ·Ù„Ø¨ Ø§Ù„ØªØ¹Ø±Ù Ø§ØªØµØ§Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.'; break;
          default: msg = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡ Ø§Ù„ØµÙˆØªÙŠ: ' + e.error; break;
        }
        try { console.warn(msg); } catch(_) {}
        // Ø®ÙŠØ§Ø± Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (micBtn) micBtn.title = msg;
        try {
          var stateEl = document.getElementById('stt_state');
          if (stateEl) stateEl.textContent = msg;
        } catch(_){}
      }
    };

    recognition.onend = function () {
      if (active) {
        try { recognition.start(); } catch (e) { /* ignore */ }
      } else {
        micBtn.classList.remove('recording');
        micBtn.title = 'Ø¥Ù…Ù„Ø§Ø¡ ØµÙˆØªÙŠ (Ø¹Ø±Ø¨ÙŠ)';
      }
    };

    function start() {
      active = true;
      micBtn.classList.add('recording');
      micBtn.title = 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„â€¦ Ø§Ø¶ØºØ· Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù';
      targetEl = getEditorEl();
      if (targetEl) {
        targetEl.focus();
        if (targetEl.isContentEditable) {
          placeAnchorForContentEditable(targetEl);
        }
      }
      committedLen = 0;
      try {
        var stateEl = document.getElementById('stt_state');
        if (stateEl) stateEl.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹â€¦';
        var prevEl = document.getElementById('stt_preview');
        if (prevEl) prevEl.textContent = '';
      } catch(_){}
      try { recognition.start(); } catch (e) {
        // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø¨Ø¯Ø¡ØŒ Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ "ar"
        try { recognition.lang = 'ar'; recognition.start(); } catch (_) {}
      }
    }
    function stop() {
      active = false;
      try { recognition.stop(); } catch (e) { /* ignore */ }
      micBtn.classList.remove('recording');
      micBtn.title = 'Ø¥Ù…Ù„Ø§Ø¡ ØµÙˆØªÙŠ (Ø¹Ø±Ø¨ÙŠ)';
      cleanupAnchor();
      targetEl = null;
      committedLen = 0;
      try {
        var stateEl = document.getElementById('stt_state');
        if (stateEl) stateEl.textContent = 'Ù…ØªÙˆÙ‚Ù';
      } catch(_){}
    }

    // Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø±Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.addEventListener('focusin', function (e) {
      var form = document.getElementById('contentForm');
      if (form && form.contains(e.target)) {
        if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT' || e.target.isContentEditable) {
          e.target.setAttribute('data-editor', '1');
        }
      }
    });

    micBtn.addEventListener('click', function () {
      if (active) stop(); else start();
    });
  });
</script>

<form method="post" id="contentForm" class="stack" action="">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="content" />
        <!-- Ø­Ù‚Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø®ÙÙŠ: Ø³ÙŠØªÙ… Ù†Ø³Ø® HTML Ø§Ù„Ù…Ø­Ø±Ù‘Ø± Ù„Ù‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
        <div style="display:none">{{ cform.body }}</div>

        <!-- Ø§Ù„Ù…Ø­Ø±Ù‘Ø± -->
        <div id="m_editor" contenteditable="true"></div>

        <small class="muted" style="display:block;margin-top:.4rem">
          ØªÙ„Ù…ÙŠØ­: Ø­Ø¯Ù‘Ø¯ Ù†ØµÙ‹Ø§ Ø«Ù… Ø§Ø¶ØºØ· <strong>B</strong> Ù„Ø¹Ù…Ù„Ù‡ Ø¹Ø±ÙŠØ¶Ù‹Ø§.  
          Ø£Ø²Ø±Ø§Ø± <strong>â€¢ Ù‚Ø§Ø¦Ù…Ø©</strong> Ùˆ<strong>1. ØªØ¹Ø¯Ø§Ø¯</strong> ØªÙØ¶ÙŠÙØ§Ù† Ù‚ÙˆØ§Ø¦Ù….  
          Ø§Ø®ØªØ± Ù„ÙˆÙ†Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ù„ØªØ·Ø¨ÙŠÙ‚Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯. Ø²Ø± ğŸ§¹ ÙŠÙÙ†Ø¸Ù‘Ù Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©.
        </small>
      </form>
    </section>
  </div>

  <!-- ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø©: Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ + Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© + ÙƒÙ„ Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->

{% endblock %}

{% block extra_js %}
  <script>
    const editor  = document.getElementById('m_editor');
    const bodyFld = document.getElementById('id_body'); // Ù…Ù† cform.body
    const btnBold = document.getElementById('m_bold');
    const btnUL   = document.getElementById('m_ul');
    const btnOL   = document.getElementById('m_ol');
    const clean   = document.getElementById('m_clean');

    // Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ù‘Ø± (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ <em>)
    editor.innerHTML = bodyFld ? bodyFld.value : '';

    function focusEditor(){ editor.focus(); }

    // Ø£Ø¯ÙˆØ§Øª ØªÙ†Ø³ÙŠÙ‚ Ø£Ø³Ø§Ø³ÙŠØ©
    btnBold?.addEventListener('click', () => { focusEditor(); document.execCommand('bold', false, null); });
    btnUL  ?.addEventListener('click', () => { focusEditor(); document.execCommand('insertUnorderedList', false, null); });
    btnOL  ?.addEventListener('click', () => { focusEditor(); document.execCommand('insertOrderedList', false, null); });

    // Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†: 4 Ø£Ù„ÙˆØ§Ù† Ø«Ø§Ø¨ØªØ©
    document.querySelectorAll('.palette .sw').forEach(sw => {
      sw.addEventListener('click', () => {
        const color = sw.dataset.color;
        focusEditor();
        document.execCommand('foreColor', false, color);
      });
    });

    // ØªÙ†Ø¸ÙŠÙ: Ø¥Ø²Ø§Ù„Ø© &nbsp;ØŒ ØªÙ‚Ù„ÙŠØµ Ø§Ù„Ù…Ø³Ø§ÙØ§ØªØŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø­ÙˆÙ„ Ø§Ù„ÙˆØ³ÙˆÙ…
    clean  ?.addEventListener('click', () => {
      const html = editor.innerHTML
        .replace(/&nbsp;/g, ' ')
        .replace(/\s{2,}/g, ' ')
        .replace(/>\s+/g, '>')
        .replace(/\s+</g, '<')
        .trim();
      editor.innerHTML = html;
    });

    // Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸: Ø§Ù†Ø³Ø® HTML Ù„Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…Ø®ÙÙŠ body ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('contentForm')?.addEventListener('submit', () => {
      if (bodyFld) bodyFld.value = editor.innerHTML.trim();
    });
  </script>
{% endblock %}
